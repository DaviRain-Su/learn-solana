# ğŸ¤  çŠ¶æ€ç®¡ç† - è®©ä½ çš„æ•°æ®åœ¨åŒºå—é“¾ä¸Šå®‰å®¶ï¼

> ğŸ¯ **æœ¬ç« ç›®æ ‡**: æŒæ¡Solanaé“¾ä¸Šæ•°æ®å­˜å‚¨çš„æ ¸å¿ƒæŠ€èƒ½ï¼Œè®©ä½ çš„ç¨‹åºæ‹¥æœ‰"è®°å¿†"ï¼

---

## ğŸŒŸ å¼€ç¯‡ï¼šä»æ— çŠ¶æ€åˆ°æœ‰çŠ¶æ€çš„åä¸½è½¬èº«ï¼

è¿˜è®°å¾—ç¬¬ä¸€èŠ‚æˆ‘ä»¬ç©è¿‡çš„ç”µå½±è¯„è®ºç¨‹åºå—ï¼Ÿå½“æ—¶åªèƒ½çœ‹ï¼Œä¸èƒ½å†™ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬è¦èµ‹äºˆå®ƒ**çœŸæ­£çš„çµé­‚** â€”â€” è®©å®ƒèƒ½å¤Ÿè®°ä½æ¯ä¸€æ¡ç²¾å½©çš„å½±è¯„ï¼ğŸ¬

### ğŸ® ä»Šæ—¥å†’é™©åœ°å›¾

```
ğŸ“ ä½ åœ¨è¿™é‡Œï¼ˆåªä¼šæ‰“å°Helloï¼‰
    â†“
ğŸ§  ç†è§£çŠ¶æ€å­˜å‚¨ â†’ ğŸ’° è®¡ç®—ç§Ÿé‡‘ â†’ ğŸ”‘ åˆ›å»ºPDA
    â†“                â†“              â†“
æ•°æ®çš„å®¶         ä»˜æˆ¿ç§Ÿ        å®‰å…¨ä¿é™©ç®±
    â†“
ğŸ¬ æ„å»ºç”µå½±è¯„è®ºç¨‹åº â†’ ğŸš€ éƒ¨ç½²ä¸Šé“¾
    â†“
ğŸ† ä½ çš„ç¨‹åºèƒ½è®°ä½ä¸€åˆ‡äº†ï¼
```

> ğŸ’¡ **é‡è¦æ¦‚å¿µ**: åœ¨Solanaä¸­ï¼Œ"çŠ¶æ€"å°±æ˜¯å­˜å‚¨åœ¨é“¾ä¸Šçš„ç¨‹åºæ•°æ® â€”â€” ä½ çš„ç¨‹åºçš„é•¿æœŸè®°å¿†ï¼

---

## ğŸ“ å°†ç¨‹åºçŠ¶æ€ä½œä¸ºRustæ•°æ®ç±»å‹ - æ•°æ®çš„å˜å½¢è®°ï¼

### ğŸ¯ ä¸ºä»€ä¹ˆSolanaç¨‹åºæ˜¯æ— çŠ¶æ€çš„ï¼Ÿ

æƒ³è±¡ä¸€ä¸‹ä¸¤ç§é¤å…æ¨¡å¼ï¼š

```
ğŸ” ä¼ ç»ŸåŒºå—é“¾ï¼ˆæœ‰çŠ¶æ€ï¼‰
é¤å… = ç¨‹åº
å¨æˆ¿ = å†…éƒ¨å­˜å‚¨
é—®é¢˜ï¼šå¨æˆ¿å¤ªå°ï¼Œé£Ÿææœ‰é™ï¼

ğŸš€ Solanaï¼ˆæ— çŠ¶æ€ï¼‰
é¤å… = ç¨‹åºï¼ˆåªæœ‰å¨å¸ˆå’Œé£Ÿè°±ï¼‰
å†°ç®± = å¤–éƒ¨è´¦æˆ·ï¼ˆæ— é™æ‰©å±•ï¼‰
ä¼˜åŠ¿ï¼šå¯ä»¥æœ‰æ— æ•°ä¸ªå†°ç®±ï¼
```

### ğŸ”„ æ•°æ®çš„å˜å½¢è¿‡ç¨‹

```rust
// ğŸ­ æ•°æ®çš„ä¸‰ç§å½¢æ€

// 1ï¸âƒ£ åœ¨é“¾ä¸Šå­˜å‚¨æ—¶ - åŸå§‹å­—èŠ‚
è´¦æˆ·æ•°æ®: [0x48, 0x65, 0x6c, 0x6c, 0x6f...]

// 2ï¸âƒ£ åœ¨ç¨‹åºä¸­å¤„ç†æ—¶ - Rustç±»å‹
struct NoteState {
    title: String,    // "æˆ‘çš„ç¬”è®°"
    body: String,     // "å†…å®¹..."
    id: u64          // 12345
}

// 3ï¸âƒ£ ä¼ è¾“æ—¶ - åºåˆ—åŒ–çš„å­—èŠ‚
ä¼ è¾“æ•°æ®: serialize(NoteState) â†’ [bytes...]
```

### ğŸ’» ä»£ç å®ç°

```rust
// ğŸ¨ ä½¿ç”¨Borshè®©æ•°æ®ç±»å‹å…·å¤‡"å˜å½¢"èƒ½åŠ›
use borsh::{BorshDeserialize, BorshSerialize};

// ğŸ“ å®šä¹‰ç¬”è®°çš„æ•°æ®ç»“æ„
#[derive(BorshSerialize, BorshDeserialize, Debug)]
struct NoteState {
    title: String,      // ğŸ“‘ æ ‡é¢˜
    body: String,       // ğŸ“„ å†…å®¹
    id: u64,           // ğŸ”¢ å”¯ä¸€ID
}

// ğŸ¯ è¿™ä¸ªç»“æ„ä½“ç°åœ¨æ‹¥æœ‰äº†ä¸‰ä¸ªè¶…èƒ½åŠ›ï¼š
// BorshSerialize: èƒ½å˜æˆå­—èŠ‚ï¼ˆåºåˆ—åŒ–ï¼‰âœ¨
// BorshDeserialize: èƒ½ä»å­—èŠ‚è¿˜åŸï¼ˆååºåˆ—åŒ–ï¼‰ğŸ”„
// Debug: èƒ½è¢«æ‰“å°å‡ºæ¥è°ƒè¯• ğŸ›
```

> ğŸ’¡ **ç±»æ¯”ç†è§£**:
> - åºåˆ—åŒ– = æŠŠä¹é«˜æ¨¡å‹æ‹†æˆé›¶ä»¶è£…ç›’
> - ååºåˆ—åŒ– = æŠŠé›¶ä»¶é‡æ–°ç»„è£…æˆæ¨¡å‹
> - Borsh = æ‹†è£…è¯´æ˜ä¹¦

---

## ğŸ  ç©ºé—´ä¸ç§Ÿé‡‘ - åŒºå—é“¾ä¸Šçš„æˆ¿åœ°äº§ç»æµå­¦ï¼

### ğŸ’° ä¸ºä»€ä¹ˆè¦äº¤ç§Ÿé‡‘ï¼Ÿ

```
ğŸ¢ ç°å®ä¸–ç•Œ              ğŸŒ Solanaä¸–ç•Œ
æˆ¿ä¸œ = éªŒè¯è€…            ç§Ÿå®¢ = ä½ çš„ç¨‹åº
æˆ¿å­ = å­˜å‚¨ç©ºé—´          ç§Ÿé‡‘ = Lamports
æ°´ç”µ = è®¡ç®—èµ„æº          åˆåŒ = è´¦æˆ·

ä¸ºä»€ä¹ˆæ”¶ç§Ÿï¼Ÿ
1. ğŸš« é˜²æ­¢åƒåœ¾æ•°æ®ï¼ˆæ²¡äººæƒ³è¦åºŸå¼ƒæˆ¿å±‹ï¼‰
2. ğŸ’¾ è¡¥å¿éªŒè¯è€…çš„å­˜å‚¨æˆæœ¬
3. ğŸ¯ æ¿€åŠ±é«˜æ•ˆä½¿ç”¨ç©ºé—´
```

### ğŸ“Š ç§Ÿé‡‘ä»·ç›®è¡¨

ä¸åŒæ•°æ®ç±»å‹çš„"æˆ¿ç§Ÿ"ï¼ˆä»¥å­—èŠ‚è®¡ï¼‰ï¼š

```rust
// ğŸ  æ•°æ®ç±»å‹çš„ç©ºé—´å ç”¨å¯¹ç…§è¡¨

åŸºç¡€ç±»å‹ï¼ˆå›ºå®šå¤§å°ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç±»å‹      â”‚  å­—èŠ‚   â”‚   ç¤ºä¾‹        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ bool        â”‚   1    â”‚ true/false   â”‚
â”‚ u8/i8       â”‚   1    â”‚ 0-255        â”‚
â”‚ u16/i16     â”‚   2    â”‚ 0-65535      â”‚
â”‚ u32/i32     â”‚   4    â”‚ æ›´å¤§çš„æ•°å­—    â”‚
â”‚ u64/i64     â”‚   8    â”‚ è¶…å¤§æ•°å­—      â”‚
â”‚ u128/i128   â”‚   16   â”‚ å·¨å¤§æ•°å­—      â”‚
â”‚ Pubkey      â”‚   32   â”‚ å…¬é’¥åœ°å€      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åŠ¨æ€ç±»å‹ï¼ˆå¯å˜å¤§å°ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç±»å‹      â”‚     å­—èŠ‚         â”‚    è¯´æ˜       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ String      â”‚ 4 + é•¿åº¦         â”‚ 4å­—èŠ‚å­˜é•¿åº¦   â”‚
â”‚ Vec<T>      â”‚ 4 + (é¡¹æ•° Ã— T)   â”‚ åŠ¨æ€æ•°ç»„      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ¦ ç§Ÿé‡‘æ”¯ä»˜æ–¹æ¡ˆ

```rust
// ğŸ’° ä¸¤ç§æ”¯ä»˜æ–¹å¼

// æ–¹æ¡ˆ1ï¼šæŒ‰æœŸä»˜æ¬¾ï¼ˆå·²åºŸå¼ƒï¼‰âŒ
// åƒæœˆç§Ÿï¼Œä½†å¿˜è®°äº¤ç§Ÿæ•°æ®å°±æ²¡äº†ï¼

// æ–¹æ¡ˆ2ï¼šä¸€æ¬¡æ€§ä»˜æ¸…ï¼ˆæ¨èï¼‰âœ…
// å­˜å…¥2å¹´ç§Ÿé‡‘ = æ°¸ä¹…å…ç§Ÿï¼
// åŸç†ï¼šç¡¬ä»¶æˆæœ¬æ¯2å¹´é™50%ï¼Œæ‰€ä»¥2å¹´åä½ çš„ç§Ÿé‡‘åˆ©æ¯å°±å¤Ÿäº†

// ğŸ é¢å¤–ç¦åˆ©ï¼šä¸ç”¨æ—¶å¯ä»¥å…³é—­è´¦æˆ·ï¼Œå–å›æ‰€æœ‰ç§Ÿé‡‘ï¼
```

### ğŸ’¡ ç§Ÿé‡‘è®¡ç®—ç¤ºä¾‹

```rust
// ğŸ§® è®¡ç®—æˆ‘éœ€è¦ä»˜å¤šå°‘ç§Ÿé‡‘

// å‡è®¾æˆ‘è¦å­˜å‚¨ä¸€ä¸ªç¬”è®°ï¼š
struct Note {
    title: String,      // "æˆ‘çš„æ—¥è®°" = 4 + 12 = 16å­—èŠ‚
    body: String,       // "ä»Šå¤©å¾ˆå¼€å¿ƒ" = 4 + 15 = 19å­—èŠ‚
    id: u64,           // 12345 = 8å­—èŠ‚
    is_public: bool    // true = 1å­—èŠ‚
}

// æ€»ç©ºé—´ = 16 + 19 + 8 + 1 = 44å­—èŠ‚

// è®¡ç®—ç§Ÿé‡‘ï¼ˆå¤§çº¦ï¼‰ï¼š
// 44å­—èŠ‚ â‰ˆ 0.002 SOLï¼ˆ2å¹´å…ç§Ÿï¼‰
// ç›¸å½“äº $0.1ï¼ˆæŒ‰å½“å‰ä»·æ ¼ï¼‰â€”â€” è¶…ä¾¿å®œï¼ğŸ’¸
```

> ğŸ¯ **çœé’±æŠ€å·§**:
> - ä½¿ç”¨æ›´å°çš„æ•°æ®ç±»å‹ï¼ˆu8 vs u64ï¼‰
> - é™åˆ¶å­—ç¬¦ä¸²é•¿åº¦
> - åŠæ—¶å…³é—­ä¸ç”¨çš„è´¦æˆ·å›æ”¶ç§Ÿé‡‘

---

## ğŸ“Š ç§Ÿé‡‘è®¡ç®—å®æˆ˜ - è®©æ•°å­¦å˜ç®€å•ï¼

### ğŸ§® è®¡ç®—å…¬å¼è¯¦è§£

```rust
// ğŸ¯ è¶…çº§ç¬”è®°ç¨‹åºçš„ç§Ÿé‡‘è®¡ç®—

// æ­¥éª¤1ï¸âƒ£ï¼šè®¡ç®—æ•°æ®å¤§å°
let account_len: usize =
    (4 + title.len())     // ğŸ“ æ ‡é¢˜ï¼šé•¿åº¦æ ‡è®°(4) + å®é™…å†…å®¹
    + (4 + body.len())    // ğŸ“„ æ­£æ–‡ï¼šé•¿åº¦æ ‡è®°(4) + å®é™…å†…å®¹
    + 8;                  // ğŸ”¢ IDï¼šå›ºå®š8å­—èŠ‚

// ğŸ’¡ ä¸ºä»€ä¹ˆå­—ç¬¦ä¸²è¦åŠ 4ï¼Ÿ
// å› ä¸ºéœ€è¦4ä¸ªå­—èŠ‚æ¥è®°å½•å­—ç¬¦ä¸²æœ‰å¤šé•¿ï¼
// å°±åƒåŒ…è£¹ä¸Šçš„æ ‡ç­¾å‘Šè¯‰ä½ é‡Œé¢æœ‰å¤šå°‘ä¸œè¥¿

// æ­¥éª¤2ï¸âƒ£ï¼šè·å–ç§Ÿé‡‘è®¡ç®—å™¨
let rent = Rent::get()?;  // ğŸ¦ è·å–å½“å‰ç§Ÿé‡‘è´¹ç‡

// æ­¥éª¤3ï¸âƒ£ï¼šè®¡ç®—æœ€ä½ä½™é¢ï¼ˆ2å¹´å…ç§Ÿï¼‰
let rent_lamports = rent.minimum_balance(account_len);

// ğŸ“Š å®é™…ä¾‹å­ï¼š
// æ ‡é¢˜ï¼š"æ˜Ÿé™…ç©¿è¶Šå½±è¯„" (21å­—èŠ‚)
// æ­£æ–‡ï¼š"è¿™æ˜¯ä¸€éƒ¨å…³äº..." (100å­—èŠ‚)
// æ€»è®¡ï¼š4+21 + 4+100 + 8 = 137å­—èŠ‚
// ç§Ÿé‡‘ï¼šçº¦0.0015 SOL â‰ˆ $0.075 ğŸ’°
```

### ğŸ¯ æ™ºèƒ½ä¼˜åŒ–æŠ€å·§

```rust
// âŒ æµªè´¹ç©ºé—´çš„åšæ³•
struct BadNote {
    title: String,        // ä¸é™é•¿åº¦ï¼Œå¯èƒ½å¾ˆé•¿
    created_at: String,   // "2024-01-01" ç”¨å­—ç¬¦ä¸²å­˜æ—¥æœŸ
}

// âœ… ä¼˜åŒ–åçš„åšæ³•
struct GoodNote {
    title: [u8; 50],     // å›ºå®š50å­—èŠ‚ï¼Œçœå»4å­—èŠ‚é•¿åº¦æ ‡è®°
    created_at: i64,     // ç”¨æ—¶é—´æˆ³å­˜å‚¨ï¼Œåªè¦8å­—èŠ‚
}

// ğŸ’° èŠ‚çœäº†ï¼š4å­—èŠ‚ + (æ—¥æœŸå­—ç¬¦ä¸²é•¿åº¦-8å­—èŠ‚) â‰ˆ 10+å­—èŠ‚ï¼
```

---

## ğŸ“œ ç¨‹åºæ´¾ç”Ÿåœ°å€ï¼ˆPDAï¼‰ - åŒºå—é“¾ä¸Šçš„æ™ºèƒ½ä¿é™©ç®±ï¼

### ğŸ” ä»€ä¹ˆæ˜¯PDAï¼Ÿ

æƒ³è±¡ä¸€ä¸ªç‰¹æ®Šçš„ä¿é™©ç®±ï¼š

```
ğŸ¦ ä¼ ç»Ÿä¿é™©ç®±          ğŸ”® PDAä¿é™©ç®±
éœ€è¦é’¥åŒ™ ğŸ”‘           ä¸éœ€è¦é’¥åŒ™ï¼
ä»»ä½•äººéƒ½èƒ½å¼€ï¼ˆæœ‰é’¥åŒ™ï¼‰  åªæœ‰ç‰¹å®šç¨‹åºèƒ½å¼€
å¯èƒ½ä¸¢é’¥åŒ™            æ°¸è¿œä¸ä¼šä¸¢"é’¥åŒ™"
ä¸€ä¸ªç®±å­ä¸€æŠŠé’¥åŒ™       ç¨‹åºID + ç§å­ = å”¯ä¸€åœ°å€
```

### ğŸ¯ PDAçš„é­”æ³•åŸç†

```rust
// ğŸª„ PDAç”Ÿæˆé­”æ³•å…¬å¼

// åŸæ–™ï¼ˆç§å­ï¼‰ï¼š
let seeds = [
    ç”¨æˆ·å…¬é’¥,        // ğŸ‘¤ è°çš„æ•°æ®
    "ç¬”è®°",          // ğŸ“ æ•°æ®ç±»å‹
    ç¬”è®°ID           // ğŸ”¢ å…·ä½“å“ªæ¡
];

// é­”æ³•å’’è¯­ï¼š
let (pda_address, bump_seed) = Pubkey::find_program_address(
    &seeds,         // ğŸŒ± ç§å­ç»„åˆ
    &program_id     // ğŸ­ å“ªä¸ªç¨‹åº
);

// ç»“æœï¼š
// pda_address = ç‹¬ä¸€æ— äºŒçš„åœ°å€ï¼
// bump_seed = é­”æ³•æ•°å­—ï¼ˆç¡®ä¿åœ°å€ä¸åœ¨æ¤­åœ†æ›²çº¿ä¸Šï¼‰
```

### ğŸ’¡ PDAçš„è¶…èƒ½åŠ›

```rust
// ğŸ¦¸ PDAçš„ä¸‰å¤§è¶…èƒ½åŠ›

// 1ï¸âƒ£ ç¡®å®šæ€§ï¼šç›¸åŒè¾“å…¥ = ç›¸åŒåœ°å€
find_program_address([user, "note", 1], program_id)
// æ°¸è¿œå¾—åˆ°åŒä¸€ä¸ªåœ°å€ï¼

// 2ï¸âƒ£ æ— ç§é’¥ï¼šæ²¡æœ‰å¯¹åº”çš„ç§é’¥
// æ„å‘³ç€ï¼š
// âœ… æ°¸è¿œä¸ä¼šä¸¢ç§é’¥
// âœ… åªæœ‰ç¨‹åºèƒ½æ§åˆ¶
// âœ… è¶…çº§å®‰å…¨

// 3ï¸âƒ£ ç¨‹åºç­¾åï¼šç¨‹åºå¯ä»¥ä¸ºPDAç­¾å
invoke_signed(
    &instruction,
    &accounts,
    &[&[seeds, &[bump]]]  // ğŸ” ç¨‹åºçš„ç­¾åæƒ
);
```

---

## ğŸ›« è·¨ç¨‹åºè°ƒç”¨ï¼ˆCPIï¼‰ - ç¨‹åºé—´çš„åä½œï¼

### ğŸ¤ ä»€ä¹ˆæ˜¯CPIï¼Ÿ

```
ğŸ­ ç°å®ç±»æ¯”ï¼š
ä½ çš„ç¨‹åº = å¯¼æ¼” ğŸ¬
ç³»ç»Ÿç¨‹åº = æ‘„å½±å¸ˆ ğŸ“¹
CPI = "æ‘„å½±å¸ˆï¼Œè¯·æ‹è¿™ä¸ªé•œå¤´ï¼"

ç»“æœï¼šå¯¼æ¼”ä¸ç”¨è‡ªå·±æ‰›æ‘„åƒæœºï¼
```

### ğŸ“ ä¸¤ç§è°ƒç”¨æ–¹å¼

```rust
// ğŸ”µ æ–¹å¼1: invoke - æ™®é€šè°ƒç”¨ï¼ˆä¸éœ€è¦ç­¾åï¼‰
pub fn invoke(
    instruction: &Instruction,     // ğŸ“‹ è¦æ‰§è¡Œçš„æŒ‡ä»¤
    account_infos: &[AccountInfo],  // ğŸ“¦ æ¶‰åŠçš„è´¦æˆ·
) -> ProgramResult

// ä½¿ç”¨åœºæ™¯ï¼šè½¬è´¦ç»™åˆ«äººï¼ˆä½ æœ‰ç§é’¥ï¼‰
invoke(
    &transfer_instruction,
    &[from_account, to_account, system_program],
)?;

// ğŸ”´ æ–¹å¼2: invoke_signed - éœ€è¦ç¨‹åºç­¾åï¼ˆPDAä¸“ç”¨ï¼‰
pub fn invoke_signed(
    instruction: &Instruction,     // ğŸ“‹ è¦æ‰§è¡Œçš„æŒ‡ä»¤
    account_infos: &[AccountInfo], // ğŸ“¦ æ¶‰åŠçš„è´¦æˆ·
    signers_seeds: &[&[u8]],      // ğŸ”‘ PDAç§å­ï¼ˆç¨‹åºçš„ç­¾åï¼‰
) -> ProgramResult

// ä½¿ç”¨åœºæ™¯ï¼šä»PDAè´¦æˆ·è½¬è´¦ï¼ˆç¨‹åºä»£ä¸ºç­¾åï¼‰
invoke_signed(
    &transfer_instruction,
    &[pda_account, to_account, system_program],
    &[&[user.key.as_ref(), b"vault", &[bump]]], // ğŸ” PDAç§å­
)?;
```

### ğŸ¨ å®Œæ•´çš„CPIç¤ºä¾‹

```rust
// ğŸ—ï¸ åˆ›å»ºPDAè´¦æˆ·çš„å®Œæ•´æµç¨‹

// 1ï¸âƒ£ å‡†å¤‡ç§å­
let seeds = &[
    initializer.key.as_ref(),  // ğŸ‘¤ ç”¨æˆ·å…¬é’¥
    b"movie-review",           // ğŸ¬ ç±»å‹æ ‡è¯†
    title.as_bytes(),          // ğŸ“ ç”µå½±æ ‡é¢˜
];

// 2ï¸âƒ£ ç”ŸæˆPDAåœ°å€
let (pda, bump) = Pubkey::find_program_address(seeds, program_id);

// 3ï¸âƒ£ è®¡ç®—ç©ºé—´å’Œç§Ÿé‡‘
let space = 1 + 4 + title.len() + 4 + review.len();
let rent = Rent::get()?.minimum_balance(space);

// 4ï¸âƒ£ åˆ›å»ºè´¦æˆ·ï¼ˆCPIè°ƒç”¨ï¼‰
invoke_signed(
    // æŒ‡ä»¤ï¼šåˆ›å»ºè´¦æˆ·
    &system_instruction::create_account(
        initializer.key,     // ğŸ’° è°ä»˜é’±
        &pda,               // ğŸ“ æ–°è´¦æˆ·åœ°å€
        rent,               // ğŸ’µ ç§Ÿé‡‘
        space as u64,       // ğŸ“ ç©ºé—´å¤§å°
        program_id,         // ğŸ­ æ‰€æœ‰è€…ç¨‹åº
    ),
    // è´¦æˆ·åˆ—è¡¨
    &[initializer.clone(), pda_account.clone(), system_program.clone()],
    // PDAç§å­ï¼ˆåŠ ä¸Šbumpï¼‰
    &[&[
        initializer.key.as_ref(),
        b"movie-review",
        title.as_bytes(),
        &[bump]  // ğŸ¯ é‡è¦ï¼šåŠ ä¸Šbumpï¼
    ]],
)?;

msg!("ğŸ‰ PDAåˆ›å»ºæˆåŠŸ: {}", pda);
```

---

## âœ‚ï¸ è´¦æˆ·æ•°æ®çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ– - æ•°æ®çš„æ‰“åŒ…ä¸æ‹†åŒ…ï¼

### ğŸ“¦ ååºåˆ—åŒ–ï¼šä»å­—èŠ‚åˆ°ç»“æ„ä½“

```rust
// ğŸ æ‹†åŒ…è¿‡ç¨‹ï¼šæŠŠå­—èŠ‚æ•°ç»„å˜æˆå¯ç”¨çš„Rustç±»å‹

// 1ï¸âƒ£ å€Ÿç”¨è´¦æˆ·æ•°æ®ï¼ˆä¸è·å–æ‰€æœ‰æƒï¼‰
let borrowed_data = pda_account.data.borrow();

// 2ï¸âƒ£ ååºåˆ—åŒ–æˆRustç±»å‹
let mut account_data = try_from_slice_unchecked::<MovieAccountState>(
    &borrowed_data
).unwrap();

// 3ï¸âƒ£ ç°åœ¨å¯ä»¥åƒæ“ä½œæ™®é€šå¯¹è±¡ä¸€æ ·æ“ä½œäº†ï¼
account_data.title = "æ˜Ÿé™…ç©¿è¶Š".to_string();
account_data.rating = 5;
account_data.description = "éœ‡æ’¼äººå¿ƒçš„ç§‘å¹»å·¨ä½œï¼".to_string();

// ğŸ’¡ ç†è§£å€Ÿç”¨ï¼š
// borrow() = "è®©æˆ‘çœ‹çœ‹æ•°æ®"ï¼ˆåªè¯»ï¼‰
// borrow_mut() = "è®©æˆ‘æ”¹æ”¹æ•°æ®"ï¼ˆå¯å†™ï¼‰
```

### ğŸ“¤ åºåˆ—åŒ–ï¼šä»ç»“æ„ä½“åˆ°å­—èŠ‚

```rust
// ğŸ æ‰“åŒ…è¿‡ç¨‹ï¼šæŠŠRustç±»å‹å˜å›å­—èŠ‚æ•°ç»„å­˜å‚¨

// è¿™è¡Œä»£ç çœ‹èµ·æ¥å¾ˆå¤æ‚ï¼Œè®©æˆ‘ä»¬åˆ†è§£å®ƒï¼š
account_data.serialize(&mut &mut pda_account.data.borrow_mut()[..])?;

// ğŸ“– é€æ­¥è§£é‡Šï¼š
// 1. pda_account.data.borrow_mut() - è·å–å¯å˜å€Ÿç”¨
// 2. [..] - è½¬æ¢ä¸ºåˆ‡ç‰‡ï¼ˆsliceï¼‰
// 3. &mut &mut - åˆ›å»ºå¯å˜å¼•ç”¨çš„å¯å˜å¼•ç”¨ï¼ˆRustç‰¹è‰²ï¼‰
// 4. serialize() - æ‰§è¡Œåºåˆ—åŒ–
// 5. ? - å¤„ç†å¯èƒ½çš„é”™è¯¯

// ğŸ’¡ ç®€å•ç†è§£ï¼šæŠŠä¿®æ”¹åçš„æ•°æ®ä¿å­˜å›è´¦æˆ·
```

### ğŸ”„ å®Œæ•´çš„è¯»æ”¹å†™æµç¨‹

```rust
// ğŸ¯ å®Œæ•´ç¤ºä¾‹ï¼šæ›´æ–°ç”µå½±è¯„è®º

// è¯»å– ğŸ“–
let mut review = try_from_slice_unchecked::<MovieAccountState>(
    &pda_account.data.borrow()
).unwrap();

msg!("ğŸ“– åŸè¯„åˆ†: {}", review.rating);

// ä¿®æ”¹ âœï¸
review.rating = new_rating;
review.description = new_description;
review.last_updated = Clock::get()?.unix_timestamp;

msg!("âœï¸ æ–°è¯„åˆ†: {}", review.rating);

// å†™å› ğŸ’¾
review.serialize(&mut &mut pda_account.data.borrow_mut()[..])?;

msg!("ğŸ’¾ è¯„è®ºå·²æ›´æ–°ï¼");
```

---

## ğŸ“¼ æ€»ç»“ - å®Œæ•´æµç¨‹å›é¡¾ï¼

### ğŸ¬ æ•°æ®å­˜å‚¨çš„å®Œæ•´å‰§æœ¬

```
ğŸ¬ åœºæ™¯ï¼šç”¨æˆ·è¦å­˜å‚¨ä¸€æ¡ç”µå½±è¯„è®º

ç¬¬1å¹•ï¼šæ¥æ”¶æŒ‡ä»¤ ğŸ“¨
â”œâ”€â”€ ç”¨æˆ·å‘é€ï¼šç”µå½±å + è¯„åˆ† + è¯„è®º
â””â”€â”€ ç¨‹åºæ¥æ”¶ï¼šè§£ææŒ‡ä»¤æ•°æ®

ç¬¬2å¹•ï¼šå‡†å¤‡å­˜å‚¨ ğŸ—ï¸
â”œâ”€â”€ è®¡ç®—éœ€è¦ç©ºé—´ï¼šæ ‡é¢˜é•¿åº¦ + è¯„è®ºé•¿åº¦ + è¯„åˆ†
â”œâ”€â”€ è®¡ç®—ç§Ÿé‡‘ï¼šRent::get()?.minimum_balance(space)
â””â”€â”€ ç”ŸæˆPDAåœ°å€ï¼šfind_program_address()

ç¬¬3å¹•ï¼šåˆ›å»ºè´¦æˆ· ğŸ 
â”œâ”€â”€ è°ƒç”¨ç³»ç»Ÿç¨‹åºï¼šinvoke_signed()
â”œâ”€â”€ åˆ›å»ºæ–°è´¦æˆ·ï¼šæŒ‡å®šå¤§å°å’Œæ‰€æœ‰è€…
â””â”€â”€ æ”¯ä»˜ç§Ÿé‡‘ï¼šä»ç”¨æˆ·è´¦æˆ·æ‰£é™¤

ç¬¬4å¹•ï¼šå­˜å‚¨æ•°æ® ğŸ’¾
â”œâ”€â”€ ååºåˆ—åŒ–ï¼šç©ºè´¦æˆ· â†’ Rustç»“æ„ä½“
â”œâ”€â”€ å¡«å……æ•°æ®ï¼šæ ‡é¢˜ã€è¯„åˆ†ã€è¯„è®º
â”œâ”€â”€ åºåˆ—åŒ–ï¼šRustç»“æ„ä½“ â†’ å­—èŠ‚æ•°ç»„
â””â”€â”€ ä¿å­˜ï¼šå†™å…¥è´¦æˆ·dataå­—æ®µ

ç¬¬5å¹•ï¼šå®Œæˆï¼ ğŸ‰
â””â”€â”€ æ•°æ®æ°¸ä¹…ä¿å­˜åœ¨åŒºå—é“¾ä¸Šï¼
```

---

## ğŸ¥ å®æˆ˜ï¼šæ„å»ºç”µå½±è¯„è®ºç¨‹åºï¼

### ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
ğŸ“¦ ç”µå½±è¯„è®ºç¨‹åº
 â”£ ğŸ“„ lib.rs          # ä¸»å…¥å£
 â”£ ğŸ“„ instruction.rs  # æŒ‡ä»¤å¤„ç†
 â”£ ğŸ“„ state.rs       # æ•°æ®ç»“æ„
 â”— ğŸ“„ processor.rs   # ä¸šåŠ¡é€»è¾‘
```

### ğŸ“ Step 1: å®šä¹‰æ•°æ®ç»“æ„

åˆ›å»º `state.rs`ï¼š

```rust
// ğŸ¬ ç”µå½±è¯„è®ºçš„æ•°æ®ç»“æ„
use borsh::{BorshSerialize, BorshDeserialize};

#[derive(BorshSerialize, BorshDeserialize)]
pub struct MovieAccountState {
    pub is_initialized: bool,  // ğŸ” æ˜¯å¦å·²åˆå§‹åŒ–ï¼ˆé˜²æ­¢é‡å¤åˆ›å»ºï¼‰
    pub rating: u8,            // â­ è¯„åˆ† (1-5æ˜Ÿ)
    pub title: String,         // ğŸ¬ ç”µå½±æ ‡é¢˜
    pub description: String,   // ğŸ“ è¯„è®ºå†…å®¹
}

// ğŸ’¡ å°æŠ€å·§ï¼šis_initializedé˜²æ­¢è´¦æˆ·è¢«è¦†ç›–ï¼
```

### ğŸ“š Step 2: æ›´æ–°å¯¼å…¥

æ›´æ–° `lib.rs`ï¼š

```rust
// ğŸ¯ å¯¼å…¥æ‰€æœ‰éœ€è¦çš„å·¥å…·
use solana_program::{
    entrypoint,                             // ğŸšª ç¨‹åºå…¥å£
    entrypoint::ProgramResult,               // âœ… ç»“æœç±»å‹
    pubkey::Pubkey,                         // ğŸ”‘ å…¬é’¥
    msg,                                     // ğŸ“¢ æ—¥å¿—
    account_info::{next_account_info, AccountInfo}, // ğŸ“¦ è´¦æˆ·å¤„ç†
    system_instruction,                      // ğŸ’» ç³»ç»ŸæŒ‡ä»¤
    sysvar::{rent::Rent, Sysvar},           // ğŸ  ç§Ÿé‡‘
    program::invoke_signed,                  // ğŸ“ CPIè°ƒç”¨
    borsh::try_from_slice_unchecked,        // ğŸ”„ ååºåˆ—åŒ–
};
use std::convert::TryInto;
use borsh::BorshSerialize;

// ğŸ“¦ å¯¼å…¥æˆ‘ä»¬çš„æ¨¡å—
pub mod instruction;
pub mod state;
use instruction::MovieInstruction;
use state::MovieAccountState;
```

### ğŸ® Step 3: å®ç°æ ¸å¿ƒé€»è¾‘

```rust
// ğŸ¬ æ·»åŠ ç”µå½±è¯„è®ºçš„å®Œæ•´å®ç°
pub fn add_movie_review(
    program_id: &Pubkey,
    accounts: &[AccountInfo],
    title: String,
    rating: u8,
    description: String
) -> ProgramResult {
    msg!("ğŸ¬ å¼€å§‹æ·»åŠ ç”µå½±è¯„è®º...");
    msg!("  ğŸ“½ï¸ ç”µå½±: {}", title);
    msg!("  â­ è¯„åˆ†: {}/5", rating);

    // 1ï¸âƒ£ è·å–è´¦æˆ·
    let account_info_iter = &mut accounts.iter();
    let initializer = next_account_info(account_info_iter)?;  // ç”¨æˆ·
    let pda_account = next_account_info(account_info_iter)?;  // PDA
    let system_program = next_account_info(account_info_iter)?; // ç³»ç»Ÿ

    // 2ï¸âƒ£ éªŒè¯ç”¨æˆ·ç­¾å
    if !initializer.is_signer {
        msg!("âŒ é”™è¯¯ï¼šç”¨æˆ·æœªç­¾åï¼");
        return Err(ProgramError::MissingRequiredSignature);
    }

    // 3ï¸âƒ£ ç”ŸæˆPDA
    let (pda, bump_seed) = Pubkey::find_program_address(
        &[
            initializer.key.as_ref(),
            title.as_bytes().as_ref(),
        ],
        program_id
    );

    msg!("ğŸ“ PDAåœ°å€: {}", pda);

    // 4ï¸âƒ£ éªŒè¯PDAåŒ¹é…
    if pda != *pda_account.key {
        msg!("âŒ PDAä¸åŒ¹é…!");
        return Err(ProgramError::InvalidAccountData);
    }

    // 5ï¸âƒ£ è®¡ç®—ç©ºé—´å’Œç§Ÿé‡‘
    let account_len: usize = 1 + 1 + (4 + title.len()) + (4 + description.len());
    let rent = Rent::get()?;
    let rent_lamports = rent.minimum_balance(account_len);

    msg!("ğŸ’° éœ€è¦ç§Ÿé‡‘: {} lamports", rent_lamports);

    // 6ï¸âƒ£ åˆ›å»ºè´¦æˆ·
    if pda_account.data_len() == 0 {
        msg!("ğŸ—ï¸ åˆ›å»ºæ–°PDAè´¦æˆ·...");

        invoke_signed(
            &system_instruction::create_account(
                initializer.key,
                pda_account.key,
                rent_lamports,
                account_len.try_into().unwrap(),
                program_id,
            ),
            &[initializer.clone(), pda_account.clone(), system_program.clone()],
            &[&[initializer.key.as_ref(), title.as_bytes().as_ref(), &[bump_seed]]],
        )?;

        msg!("âœ… è´¦æˆ·åˆ›å»ºæˆåŠŸï¼");
    }

    // 7ï¸âƒ£ æ›´æ–°è´¦æˆ·æ•°æ®
    msg!("ğŸ“ å†™å…¥è¯„è®ºæ•°æ®...");

    let mut account_data = try_from_slice_unchecked::<MovieAccountState>(
        &pda_account.data.borrow()
    ).unwrap();

    // æ£€æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–
    if account_data.is_initialized {
        msg!("âš ï¸ è´¦æˆ·å·²å­˜åœ¨ï¼Œæ›´æ–°è¯„è®º");
    }

    // æ›´æ–°æ•°æ®
    account_data.title = title;
    account_data.rating = rating;
    account_data.description = description;
    account_data.is_initialized = true;

    // ä¿å­˜æ•°æ®
    account_data.serialize(&mut &mut pda_account.data.borrow_mut()[..])?;

    msg!("ğŸ‰ ç”µå½±è¯„è®ºä¿å­˜æˆåŠŸï¼");
    Ok(())
}
```

### ğŸ§ª Step 4: æµ‹è¯•ä½ çš„ç¨‹åº

```typescript
// ğŸ¯ å®¢æˆ·ç«¯æµ‹è¯•ä»£ç 
import {
    Connection,
    PublicKey,
    Transaction,
    TransactionInstruction,
    sendAndConfirmTransaction,
    Keypair
} from '@solana/web3.js';

// ğŸ¬ åˆ›å»ºè¯„è®º
async function createMovieReview(
    title: string,
    rating: number,
    description: string
) {
    // ğŸ“¦ å‡†å¤‡æŒ‡ä»¤æ•°æ®
    const instruction = new TransactionInstruction({
        keys: [
            { pubkey: wallet.publicKey, isSigner: true, isWritable: true },
            { pubkey: pda, isSigner: false, isWritable: true },
            { pubkey: SystemProgram.programId, isSigner: false, isWritable: false }
        ],
        programId: PROGRAM_ID,
        data: Buffer.from([
            0,  // æŒ‡ä»¤ç±»å‹
            ...Buffer.from(title),
            rating,
            ...Buffer.from(description)
        ])
    });

    // ğŸš€ å‘é€äº¤æ˜“
    const tx = new Transaction().add(instruction);
    const signature = await sendAndConfirmTransaction(connection, tx, [wallet]);

    console.log('ğŸ‰ è¯„è®ºå·²æäº¤ï¼');
    console.log('ğŸ”— äº¤æ˜“ç­¾å:', signature);
}
```

---

## ğŸ’¡ ä¸“ä¸šæŠ€å·§å¤§æ”¾é€ï¼

### ğŸš€ æ€§èƒ½ä¼˜åŒ–

```rust
// âœ… å¥½çš„å®è·µ
// 1. é¢„å…ˆéªŒè¯ï¼Œå¤±è´¥è¦æ—©
if !initializer.is_signer {
    return Err(ProgramError::MissingRequiredSignature);
}

// 2. æ‰¹é‡å¤„ç†å‡å°‘CPI
let instructions = vec![create_account, initialize_data];
for ix in instructions {
    invoke_signed(&ix, accounts, signers)?;
}

// 3. ä½¿ç”¨å›ºå®šå¤§å°æ•°ç»„èŠ‚çœç©ºé—´
pub struct OptimizedState {
    pub title: [u8; 50],  // å›ºå®š50å­—èŠ‚ï¼Œä¸ç”¨4å­—èŠ‚é•¿åº¦å‰ç¼€
    pub rating: u8,
}
```

### ğŸ› è°ƒè¯•æŠ€å·§

```rust
// ğŸ” æ·»åŠ è¯¦ç»†æ—¥å¿—
msg!("Debug: account_len={}, rent={}", account_len, rent_lamports);

// ğŸ¯ ä½¿ç”¨æ–­è¨€éªŒè¯
assert!(rating <= 5, "è¯„åˆ†å¿…é¡»åœ¨1-5ä¹‹é—´");

// ğŸ’¡ åˆ†æ­¥æ‰§è¡Œï¼Œä¾¿äºå®šä½é—®é¢˜
msg!("Step 1: Validated inputs âœ“");
msg!("Step 2: Generated PDA âœ“");
msg!("Step 3: Created account âœ“");
```

---

## ğŸš¢ ç»ˆææŒ‘æˆ˜ï¼

### ğŸ¯ ä»»åŠ¡ï¼šå­¦ç”Ÿä»‹ç»ç¨‹åº

åˆ›å»ºä¸€ä¸ªç¨‹åºï¼Œè®©å­¦ç”Ÿå¯ä»¥ï¼š
1. ğŸ“ æäº¤å§“åå’Œè‡ªæˆ‘ä»‹ç»
2. ğŸ’¾ æ•°æ®æ°¸ä¹…ä¿å­˜åœ¨é“¾ä¸Š
3. ğŸ”„ å¯ä»¥æ›´æ–°ä»‹ç»å†…å®¹

```rust
// ğŸ’¡ æç¤ºï¼šæ•°æ®ç»“æ„
pub struct StudentIntro {
    pub is_initialized: bool,
    pub name: String,
    pub message: String,
}

// ğŸ¯ æŒ‘æˆ˜è¦æ±‚ï¼š
// 1. æ¯ä¸ªå­¦ç”Ÿä¸€ä¸ªç‹¬ç«‹PDA
// 2. é˜²æ­¢é‡å¤åˆå§‹åŒ–
// 3. æ”¯æŒæ›´æ–°åŠŸèƒ½
```

### ğŸ† æˆåŠŸæ ‡å‡†

- âœ… èƒ½åˆ›å»ºå­¦ç”Ÿä»‹ç»
- âœ… æ•°æ®æ­£ç¡®å­˜å‚¨
- âœ… èƒ½åœ¨ExploreræŸ¥çœ‹
- âœ… æ”¯æŒæ›´æ–°æ“ä½œ

---

## ğŸŠ æ­å–œå®Œæˆï¼

### ğŸ“Š ä½ çš„æˆå°±

```
ğŸ† æŒæ¡æŠ€èƒ½æ¸…å•ï¼š
âœ… SolanaçŠ¶æ€ç®¡ç†
âœ… PDAåˆ›å»ºå’Œä½¿ç”¨
âœ… è·¨ç¨‹åºè°ƒç”¨(CPI)
âœ… åºåˆ—åŒ–/ååºåˆ—åŒ–
âœ… ç§Ÿé‡‘è®¡ç®—
âœ… å®Œæ•´ç¨‹åºå¼€å‘
```

### ğŸš€ ä¸‹ä¸€æ­¥

- æ·»åŠ æ›´å¤šåŠŸèƒ½ï¼ˆåˆ é™¤ã€æŸ¥è¯¢ï¼‰
- å®ç°æƒé™æ§åˆ¶
- åˆ›å»ºå‰ç«¯ç•Œé¢
- éƒ¨ç½²åˆ°ä¸»ç½‘ï¼

---

> ğŸŒŸ **æ¿€åŠ±è¯­**: "ä½ å·²ç»æŒæ¡äº†Solanaå¼€å‘çš„æ ¸å¿ƒæŠ€èƒ½ï¼æ¯ä¸€è¡Œä»£ç éƒ½è®©ä½ ç¦»Web3å¤§å¸ˆæ›´è¿‘ä¸€æ­¥ï¼" ğŸš€

**#SolanaState #Web3Storage #BlockchainDev** ğŸ¤ ğŸ’¾âœ¨
